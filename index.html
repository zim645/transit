<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victoria Falls Transit Planner</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        #map {
            height: 400px;
            width: 100%;
        }
        .login-tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .login-tab.active {
            border-bottom: 2px solid #4f46e5;
            color: #4f46e5;
            font-weight: 600;
        }
        /* Style for the message box */
        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            z-index: 1000;
            display: none; /* Hidden by default */
            font-size: 1.1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.5rem;
            z-index: 10000;
            display: none; /* Hidden by default */
        }
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100">
    <!-- Message Box -->
    <div id="message-box" class="fixed"></div>
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p class="ml-4">Loading...</p>
    </div>

    <div id="app" class="min-h-screen flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-3xl mx-auto bg-white rounded-2xl shadow-2xl p-6">
            <header class="text-center mb-8">
                <h1 class="text-3xl font-bold text-gray-800">Victoria Falls Transit Planner</h1>
                <p class="text-gray-600 mt-2">Your guide to getting around in Vic Falls, Zimbabwe.</p>
            </header>

            <div id="auth-section" class="mb-6">
                <div class="flex justify-center space-x-4 mb-4">
                    <div class="login-tab active" data-tab="passenger">Passenger</div>
                    <div class="login-tab" data-tab="admin">Admin</div>
                </div>

                <!-- Passenger Login -->
                <div id="passenger-login" class="auth-form">
                    <h2 class="text-xl font-bold mb-4">Passenger Login</h2>
                    <input type="text" id="passengerUsername" placeholder="Username" class="border p-2 w-full mb-2 rounded-md">
                    <input type="password" id="passengerPassword" placeholder="Password" class="border p-2 w-full mb-4 rounded-md">
                    <button id="passengerLoginBtn" class="btn-primary w-full rounded-md">Login as Passenger</button>
                </div>

                <!-- Admin Login -->
                <div id="admin-login" class="auth-form hidden">
                    <h2 class="text-xl font-bold mb-4">Admin Login</h2>
                    <input type="text" id="adminUsername" placeholder="Username" class="border p-2 w-full mb-2 rounded-md">
                    <input type="password" id="adminPassword" placeholder="Password" class="border p-2 w-full mb-4 rounded-md">
                    <button id="adminLoginBtn" class="btn-primary w-full rounded-md">Login as Admin</button>
                </div>
            </div>

            <div id="admin-dashboard" class="hidden">
                <div class="flex justify-center space-x-4 mb-4">
                    <div class="login-tab active" data-tab="register-driver">Register Driver</div>
                    <div class="login-tab" data-tab="manage-drivers">Manage Drivers</div>
                </div>

                <!-- Driver Registration -->
                <div id="driver-registration" class="auth-form">
                    <button id="backToLoginAdmin" class="btn-primary mb-4 rounded-md">Back to Login</button>
                    <h2 class="text-xl font-bold mb-4">Driver Registration</h2>
                    <input type="text" id="driverName" placeholder="Driver Name" class="border p-2 w-full mb-2 rounded-md">
                    <input type="text" id="driverPhone" placeholder="Phone Number (e.g., +263771234567)" class="border p-2 w-full mb-2 rounded-md">
                    <input type="text" id="driverCarReg" placeholder="Car Registration Number" class="border p-2 w-full mb-2 rounded-md">
                    <!-- Removed driverCapacity, driverLatitude, driverLongitude inputs -->
                    <button id="registerDriverBtn" class="btn-primary w-full rounded-md">Register Driver</button>
                </div>

                <!-- Manage Drivers -->
                <div id="manage-drivers" class="auth-form hidden">
                    <button id="backToLoginAdmin2" class="btn-primary mb-4 rounded-md">Back to Login</button>
                    <h2 class="text-xl font-bold mb-4">Manage Registered Drivers</h2>
                    <div id="driver-list-container" class="mt-4"></div>
                    <button id="refreshDriversBtn" class="btn-primary w-full mt-4 rounded-md">Refresh Drivers</button>
                </div>
            </div>

            <div id="main-app" class="hidden">
                <button id="backToLogin" class="btn-primary mb-4 rounded-md">Back to Login</button>
                <h2 class="text-xl font-bold mb-4">Plan Your Trip</h2>
                <div class="flex items-center justify-between mb-6">
                    <select id="startLocation" class="border p-2 w-1/2 rounded-md"></select>
                    <button id="swapLocations" class="btn-primary mx-2 p-2 rounded-md">Swap</button>
                    <select id="endLocation" class="border p-2 w-1/2 rounded-md"></select>
                </div>
                <input type="number" id="passengerCount" placeholder="Number of Passengers" class="border p-2 w-full mb-4 rounded-md">
                <button id="planTripBtn" class="btn-primary w-full rounded-md">Plan My Trip</button>

                <div id="paymentOptions" class="hidden mt-4">
                    <h2 class="text-xl font-bold mb-2">Select Payment Method</h2>
                    <select id="paymentMethod" class="border p-2 w-full mb-4 rounded-md">
                        <option value="cash">Cash</option>
                        <option value="transfer">Bank Transfer</option>
                    </select>
                    <button id="confirmPaymentBtn" class="btn-primary w-full rounded-md">Confirm Payment</button>
                </div>

                <div id="results" class="hidden mt-4">
                    <h2 class="text-xl font-bold mb-2">Your Trip Options</h2>
                    <div id="results-container" class="mt-4"></div>
                </div>

                <div id="ride-history" class="hidden mt-4">
                    <h2 class="text-xl font-bold mb-2">Your Ride History</h2>
                    <div id="history-container" class="mt-4"></div>
                </div>

                <div id="map" class="hidden mt-4"></div>
            </div>
        </div>
    </div>

    <script>
        // --- IMPORTANT SECURITY WARNING ---
        // For a real-world production application, directly calling an LLM API
        // with database credentials in client-side JavaScript is a major security risk.
        // All database interactions should be handled by a secure backend server (Node.js, Python, etc.)
        // that validates requests and uses its own environment variables for credentials.
        // This implementation uses the Gemini API as a conceptual backend for demonstration purposes within Canvas.

        const API_KEY = ""; // Canvas will automatically provide this. DO NOT hardcode your API key here.
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        
        // Replace with your MongoDB Atlas connection details
        // In a real app, this connection string would NEVER be in client-side code.
        // It would be securely stored on your backend server.
        const MONGODB_ATLAS_URI = "mongodb+srv://<user>:<password>@<cluster>.mongodb.net/<database>?retryWrites=true&w=majority"; 
        const MONGODB_DATABASE_NAME = "<database>"; // The actual database name you want to use in Atlas

        const localTransportData = {
            "Victoria Falls Hotel": { arrival_time: "10 min", icon: "ðŸ¨", coords: [-17.9333, 25.8267] },
            "Zambezi National Park": { arrival_time: "15 min", icon: "ðŸ˜", coords: [-17.8833, 25.6167] },
            "Town Center": { arrival_time: "5 min", icon: "ðŸ™ï¸", coords: [-17.9319, 25.8306] },
            "Victoria Falls Airport": { arrival_time: "20 min", icon: "âœˆï¸", coords: [-18.0956, 25.8392] },
            "Curio Market": { arrival_time: "7 min", icon: "ðŸ›ï¸", coords: [-17.9325, 25.8328] },
            "The Lookout Cafe": { arrival_time: "12 min", icon: "â˜•", coords: [-17.9286, 25.8425] },
            "Elephant's Walk Shopping Village": { arrival_time: "8 min", icon: "ðŸ˜", coords: [-17.9147, 25.8183] },
            "Boma Dinner & Drum Show": { arrival_time: "18 min", icon: "ðŸ¥", coords: [-17.9069, 25.8236] },
            "Victoria Falls Bridge": { arrival_time: "15 min", icon: "ðŸŒ‰", coords: [-17.9310, 25.8267] },
            "Rainbow Falls": { arrival_time: "25 min", icon: "ðŸŒˆ", coords: [-17.9267, 25.8536] },
            "Devil's Pool": { arrival_time: "30 min", icon: "ðŸ˜ˆ", coords: [-17.9278, 25.8542] },
            "Livingstone Island": { arrival_time: "35 min", icon: "ðŸï¸", coords: [-17.9283, 25.8550] },
            "Victoria Falls National Park": { arrival_time: "12 min", icon: "ðŸŒ³", coords: [-17.9281, 25.8408] },
            "Chinotimba Township": { arrival_time: "10 min", icon: "ðŸ˜ï¸", coords: [-17.9236, 25.8167] },
            "Chamabondo National Park": { arrival_time: "40 min", icon: "ðŸŒ²", coords: [-17.8500, 25.7000] },
            "Masuwe River Lodge": { arrival_time: "22 min", icon: "ðŸ•ï¸", coords: [-17.9000, 25.7833] },
            "Victoria Falls Safari Lodge": { arrival_time: "15 min", icon: "ðŸ¦", coords: [-17.9167, 25.8000] },
            "Ilala Lodge": { arrival_time: "8 min", icon: "ðŸ¡", coords: [-17.9300, 25.8283] },
            "Stanley and Livingstone Hotel": { arrival_time: "25 min", icon: "ðŸ›ï¸", coords: [-17.9667, 25.8333] },
            "Victoria Falls Backpackers": { arrival_time: "7 min", icon: "ðŸŽ’", coords: [-17.9333, 25.8333] },
            "Shearwater Explorers Village": { arrival_time: "12 min", icon: "â›º", coords: [-17.9167, 25.8167] },
            "A'Zambezi River Lodge": { arrival_time: "18 min", icon: "ðŸš£", coords: [-17.9333, 25.8000] },
            "Victoria Falls Rest Camp": { arrival_time: "10 min", icon: "â›º", coords: [-17.9333, 25.8333] },
            "The Kingdom Hotel": { arrival_time: "8 min", icon: "ðŸ°", coords: [-17.9333, 25.8333] },
            "Palm River Hotel": { arrival_time: "15 min", icon: "ðŸŒ´", coords: [-17.9333, 25.8167] },
            "Victoria Falls Rainbow Hotel": { arrival_time: "7 min", icon: "ðŸ©", coords: [-17.9333, 25.8333] },
            "Victoria Falls Hospital": { arrival_time: "10 min", icon: "ðŸ¥", coords: [-17.9333, 25.8333] },
            "Victoria Falls Police Station": { arrival_time: "8 min", icon: "ðŸ‘®", coords: [-17.9333, 25.8333] },
            "Victoria Falls Post Office": { arrival_time: "7 min", icon: "ðŸ“®", coords: [-17.9333, 25.8333] },
            "Victoria Falls Border Post": { arrival_time: "15 min", icon: "ðŸ›‚", coords: [-17.9333, 25.8333] },
            "Victoria Falls Craft Market": { arrival_time: "8 min", icon: "ðŸ›ï¸", coords: [-17.9333, 25.8333] },
            "Victoria Falls Bus Terminal": { arrival_time: "10 min", icon: "ï¿½", coords: [-17.9333, 25.8333] },
            "Victoria Falls Railway Station": { arrival_time: "12 min", icon: "ðŸš‚", coords: [-17.9333, 25.8333] },
            "Victoria Falls Golf Club": { arrival_time: "15 min", icon: "â›³", coords: [-17.9333, 25.8333] },
            "Victoria Falls Reptile Park": { arrival_time: "20 min", icon: "ðŸ", coords: [-17.9333, 25.8333] },
            "Victoria Falls Crocodile Farm": { arrival_time: "25 min", icon: "ðŸŠ", coords: [-17.9333, 25.8333] },
            "Victoria Falls Snake Park": { arrival_time: "22 min", icon: "ðŸ", coords: [-17.9333, 25.8333] },
            "Victoria Falls Lion Encounter": { arrival_time: "30 min", icon: "ðŸ¦", coords: [-17.9333, 25.8333] },
            "Victoria Falls Elephant Sanctuary": { arrival_time: "35 min", icon: "ðŸ˜", coords: [-17.9333, 25.8333] },
            "Victoria Falls Giraffe Encounter": { arrival_time: "32 min", icon: "ðŸ¦’", coords: [-17.9333, 25.8333] },
            "Victoria Falls Cheetah Encounter": { arrival_time: "28 min", icon: "ðŸ†", coords: [-17.9333, 25.8333] },
            "Victoria Falls Rhino Encounter": { arrival_time: "40 min", icon: "ðŸ¦", coords: [-17.9333, 25.8333] },
            "Victoria Falls Cultural Village": { arrival_time: "18 min", icon: "ðŸº", coords: [-17.9333, 25.8333] },
            "Victoria Falls Traditional Village": { arrival_time: "20 min", icon: "ðŸ¡", coords: [-17.9333, 25.8333] },
            "Victoria Falls Art Gallery": { arrival_time: "12 min", icon: "ðŸŽ¨", coords: [-17.9333, 25.8333] },
            "Victoria Falls Museum": { arrival_time: "15 min", icon: "ðŸ›ï¸", coords: [-17.9333, 25.8333] },
            "Victoria Falls Library": { arrival_time: "10 min", icon: "ðŸ“š", coords: [-17.9333, 25.8333] },
            "Victoria Falls Community Hall": { arrival_time: "8 min", icon: "ðŸ›ï¸", coords: [-17.9333, 25.8333] },
            "Victoria Falls Sports Club": { arrival_time: "12 min", icon: "âš½", coords: [-17.9333, 25.8333] },
            "Victoria Falls Tennis Club": { arrival_time: "15 min", icon: "ðŸŽ¾", coords: [-17.9333, 25.8333] },
            "Victoria Falls Swimming Pool": { arrival_time: "10 min", icon: "ðŸŠ", coords: [-17.9333, 25.8333] },
            "Victoria Falls Primary School": { arrival_time: "8 min", icon: "ðŸ«", coords: [-17.9333, 25.8333] },
            "Victoria Falls Secondary School": { arrival_time: "10 min", icon: "ðŸ«", coords: [-17.9333, 25.8333] },
            "Victoria Falls College": { arrival_time: "12 min", icon: "ðŸŽ“", coords: [-17.9333, 25.8333] },
            "Victoria Falls University": { arrival_time: "15 min", icon: "ðŸŽ“", coords: [-17.9333, 25.8333] },
            "Victoria Falls Technical College": { arrival_time: "18 min", icon: "ðŸ”§", coords: [-17.9333, 25.8333] },
            "Victoria Falls Business Center": { arrival_time: "10 min", icon: "ðŸ¢", coords: [-17.9333, 25.8333] },
            "Victoria Falls Industrial Area": { arrival_time: "15 min", icon: "ðŸ­", coords: [-17.9333, 25.8333] },
            "Victoria Falls Residential Area": { arrival_time: "12 min", icon: "ðŸ ", coords: [-17.9333, 25.8333] },
            "Victoria Falls High Density Area": { arrival_time: "10 min", icon: "ðŸ˜ï¸", coords: [-17.9333, 25.8333] },
            "Victoria Falls Low Density Area": { arrival_time: "15 min", icon: "ðŸ¡", coords: [-17.9333, 25.8333] },
            "Victoria Falls CBD": { arrival_time: "5 min", icon: "ðŸ™ï¸", coords: [-17.9333, 25.8333] }
        };

        let drivers = []; // This will now be populated from MongoDB
        const startLocationSelect = document.getElementById('startLocation');
        const endLocationSelect = document.getElementById('endLocation');
        const planTripBtn = document.getElementById('planTripBtn');
        const resultsDiv = document.getElementById('results');
        const resultsContainer = document.getElementById('results-container');
        const authSection = document.getElementById('auth-section');
        const mainApp = document.getElementById('main-app');
        const historyContainer = document.getElementById('history-container');
        const driverRegistration = document.getElementById('driver-registration');
        const adminDashboard = document.getElementById('admin-dashboard');
        const driverListContainer = document.getElementById('driver-list-container');

        let rideHistory = [];
        let userMarker;  // For user's location
        let isAdmin = false;

        // --- Utility Functions ---

        // Function to show custom message box instead of alert()
        function showMessageBox(message, duration = 3000) {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.style.display = 'block';
            setTimeout(() => {
                msgBox.style.display = 'none';
            }, duration);
        }

        // Function to show/hide loading overlay
        function showLoading(show) {
            document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none';
        }

        // Generate a UUID (Universally Unique Identifier)
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // --- MongoDB Atlas Interaction (Simulated via LLM) ---
        // SECURITY WARNING: In a real app, this logic would be on a secure backend server.
        // Direct client-side calls to a database API with credentials are not secure.

        async function fetchDrivers() {
            showLoading(true);
            // Updated prompt for clarity and robustness for the LLM
            const prompt = `Fetch all documents from the 'drivers' collection in the specified MongoDB Atlas database.
                            MongoDB Atlas URI: ${MONGODB_ATLAS_URI}
                            Database Name: ${MONGODB_DATABASE_NAME}
                            Collection Name: 'drivers'.
                            Ensure the response is a JSON array where each object has '_id', 'name', 'phone', 'carReg', 'capacity' (number), 'coords' ([number, number]), and 'available' (boolean).
                            If the collection is empty, return an empty JSON array [].`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { 
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "ARRAY",
                        items: {
                            type: "OBJECT",
                            properties: {
                                "_id": { "type": "STRING" },
                                "name": { "type": "STRING" },
                                "phone": { "type": "STRING" },
                                "carReg": { "type": "STRING" },
                                "capacity": { "type": "NUMBER" },
                                "coords": { "type": "ARRAY", "items": { "type": "NUMBER" } },
                                "available": { "type": "BOOLEAN" }
                            },
                            "propertyOrdering": ["_id", "name", "phone", "carReg", "capacity", "coords", "available"]
                        }
                    }
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    // Safely parse JSON, handling potential non-JSON responses from LLM
                    try {
                        drivers = JSON.parse(jsonString); // Update global drivers array
                        console.log("Fetched drivers:", drivers); // For debugging
                        displayAdminDrivers(); // Refresh admin list
                        showMessageBox("Drivers loaded successfully!", 2000);
                    } catch (e) {
                        console.error("JSON parsing error for fetched drivers:", e, "Raw LLM response:", jsonString);
                        showMessageBox("Failed to parse drivers data. LLM returned invalid JSON. Check console for details.", 4000);
                        drivers = []; // Clear drivers on error
                    }
                } else {
                    console.error("LLM response structure unexpected:", result, "Full LLM response:", JSON.stringify(result, null, 2));
                    showMessageBox("Failed to fetch drivers: Unexpected LLM response structure. Check console for details.", 4000);
                    drivers = []; // Clear drivers on error
                }
            } catch (error) {
                console.error("Error fetching drivers:", error);
                showMessageBox("Error connecting to database to fetch drivers. Check console for details.", 4000);
                drivers = []; // Clear drivers on error
            } finally {
                showLoading(false);
            }
        }

        async function insertDriver(driverData) {
            showLoading(true);
            // Updated prompt for clarity and robustness for the LLM
            const prompt = `Insert the following document into the 'drivers' collection in the specified MongoDB Atlas database.
                            MongoDB Atlas URI: ${MONGODB_ATLAS_URI}
                            Database Name: ${MONGODB_DATABASE_NAME}
                            Collection Name: 'drivers'.
                            Document to insert: ${JSON.stringify(driverData)}.
                            Return a JSON object with 'status': "success" or "error", and a 'message'.`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { 
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "status": { "type": "STRING" },
                            "message": { "type": "STRING" }
                        },
                        "propertyOrdering": ["status", "message"]
                    }
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try {
                        const parsedResult = JSON.parse(jsonString);
                        if (parsedResult.status === "success") {
                            showMessageBox(`Driver ${driverData.name} registered successfully!`, 2000);
                            await fetchDrivers(); // Refresh the list after successful insertion
                        } else {
                            showMessageBox(`Failed to register driver: ${parsedResult.message}. Check console for details.`, 4000);
                            console.error("LLM returned error status for insert:", parsedResult);
                        }
                    } catch (e) {
                        console.error("JSON parsing error for insert driver response:", e, "Raw LLM response:", jsonString);
                        showMessageBox("Failed to register driver: LLM returned invalid JSON for status. Check console for details.", 4000);
                    }
                } else {
                    console.error("LLM response structure unexpected for insert:", result, "Full LLM response:", JSON.stringify(result, null, 2));
                    showMessageBox("Failed to register driver: Unexpected LLM response structure. Check console for details.", 4000);
                }
            } catch (error) {
                console.error("Error inserting driver:", error);
                showMessageBox("Error connecting to database to register driver. Check console for details.", 4000);
            } finally {
                showLoading(false);
            }
        }

        async function deleteDriver(driverId, driverName) {
            if (!confirm(`Are you sure you want to delete driver ${driverName}?`)) {
                return; // User cancelled deletion
            }
            showLoading(true);
            // Updated prompt for clarity and robustness for the LLM
            const prompt = `Delete the document with _id "${driverId}" from the 'drivers' collection in the specified MongoDB Atlas database.
                            MongoDB Atlas URI: ${MONGODB_ATLAS_URI}
                            Database Name: ${MONGODB_DATABASE_NAME}
                            Collection Name: 'drivers'.
                            Return a JSON object with 'status': "success" or "error", and a 'message'.`;
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { 
                contents: chatHistory,
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "status": { "type": "STRING" },
                            "message": { "type": "STRING" }
                        },
                        "propertyOrdering": ["status", "message"]
                    }
                }
            };

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonString = result.candidates[0].content.parts[0].text;
                    try {
                        const parsedResult = JSON.parse(jsonString);
                        if (parsedResult.status === "success") {
                            showMessageBox(`Driver ${driverName} deleted successfully!`, 2000);
                            await fetchDrivers(); // Refresh the list after successful deletion
                        } else {
                            showMessageBox(`Failed to delete driver: ${parsedResult.message}. Check console for details.`, 4000);
                            console.error("LLM returned error status for delete:", parsedResult);
                        }
                    } catch (e) {
                        console.error("JSON parsing error for delete driver response:", e, "Raw LLM response:", jsonString);
                        showMessageBox("Failed to delete driver: LLM returned invalid JSON for status. Check console for details.", 4000);
                    }
                } else {
                    console.error("LLM response structure unexpected for delete:", result, "Full LLM response:", JSON.stringify(result, null, 2));
                    showMessageBox("Failed to delete driver: Unexpected LLM response structure. Check console for details.", 4000);
                }
            } catch (error) {
                console.error("Error deleting driver:", error);
                showMessageBox("Error connecting to database to delete driver. Check console for details.", 4000);
            } finally {
                showLoading(false);
            }
        }


        // Haversine formula to calculate distance between two coordinates
        function haversineDistance(coords1, coords2) {
            const R = 6371; // Radius of the Earth in km
            const dLat = (coords2[0] - coords1[0]) * Math.PI / 180;
            const dLon = (coords2[1] - coords1[1]) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(coords1[0] * Math.PI / 180) *
                      Math.cos(coords2[0] * Math.PI / 180) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // Updated fare calculation based on real-time distance and local rates
        function calculateFare(startCoords, endCoords) {
            const distance = haversineDistance(startCoords, endCoords);
            
            // Base fare in USD (Victoria Falls typical rates)
            const baseFare = 3.00;
            
            // Per kilometer rate (typical local rate)
            const perKmRate = 0.80;
            
            // Minimum fare
            const minimumFare = 5.00;
            
            // Calculate fare
            let fare = baseFare + (distance * perKmRate);
            
            // Apply minimum fare
            fare = Math.max(fare, minimumFare);
            
            // Additional charges for popular tourist destinations
            const touristDestinations = [
                "Victoria Falls Hotel",
                "Zambezi National Park",
                "Victoria Falls Bridge",
                "Boma Dinner & Drum Show"
            ];
            
            const destination = endLocationSelect.value;
            if (touristDestinations.includes(destination)) {
                fare += 2.50; // Tourist destination surcharge
            }
            
            // Round to nearest 0.50 for cash convenience
            fare = Math.ceil(fare * 2) / 2;
            
            return fare.toFixed(2);
        }

        // Populate locations in the dropdowns
        function populateLocations() {
            Object.keys(localTransportData).forEach(location => {
                const optionStart = new Option(location, location);
                const optionEnd = new Option(location, location);
                startLocationSelect.add(optionStart);
                endLocationSelect.add(optionEnd);
            });
        }

        // Find the closest available drivers based on passenger count
        function findClosestDrivers(passengerCount) {
            // Capacity filter removed as per new requirements, assuming all drivers can handle any capacity.
            // If capacity is to be re-introduced as a filter, it needs to be stored for each driver.
            return drivers.filter(driver => 
                driver.available !== false // Only filter by availability
            ).slice(0, 3); // Show top 3 available drivers
        }

        // Plan a trip
        function planTrip() {
            const startLocation = startLocationSelect.value;
            const endLocation = endLocationSelect.value;
            const passengerCount = document.getElementById('passengerCount').value;

            if (!startLocation || !endLocation || !passengerCount) {
                showMessageBox('Please select start/end locations and number of passengers.', 3000);
                return;
            }

            if (startLocation === endLocation) {
                showMessageBox('Start and destination cannot be the same.', 3000);
                return;
            }

            resultsContainer.innerHTML = '';
            const rideInfo = localTransportData[endLocation];
            const startCoords = localTransportData[startLocation].coords; // Get start coordinates

            // Filter drivers by availability
            const availableDrivers = drivers.filter(driver => 
                driver.available
            );

            if (availableDrivers.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="card p-4 mb-4">
                        <h3>No available drivers found for your request</h3>
                        <p>Please try again later or adjust your passenger count</p>
                    </div>
                `;
            } else {
                // Sort drivers by proximity to start location
                availableDrivers.sort((a, b) => {
                    const distA = haversineDistance(startCoords, a.coords);
                    const distB = haversineDistance(startCoords, b.coords);
                    return distA - distB;
                });

                // Display top 3 drivers
                availableDrivers.slice(0, 3).forEach(driver => {
                    const fare = calculateFare(startCoords, rideInfo.coords); // Calculate fare from start to end
                    resultsContainer.innerHTML += `
                        <div class="card p-4 mb-4">
                            <h3>${rideInfo.icon} ${endLocation}</h3>
                            <p>Arrival Time: ${rideInfo.arrival_time}</p>
                            <p>Driver: ${driver.name}</p>
                            <p>Phone: ${driver.phone}</p>
                            <p>Car Reg: ${driver.carReg}</p>
                            <p>Capacity: ${driver.capacity || 'N/A'}</p> <!-- Display capacity if it exists -->
                            <p>Status: ${driver.available ? 'Available' : 'Not Available'}</p>
                            <p>Estimated Fare: $${fare}</p>
                            <button class="btn-primary rounded-md" onclick="confirmRide('${endLocation}', '${fare}', '${driver.name}', '${driver.phone}', ${rideInfo.coords})">Confirm Ride</button>
                        </div>
                    `;
                });
            }

            resultsDiv.classList.remove('hidden');
            initMap(localTransportData["Town Center"].coords, drivers); 
        }

        // Confirm the ride and store it
        function confirmRide(destination, cost, driverName, driverPhone, destinationCoords) {
            rideHistory.push({ destination, cost, driverName, driverPhone, time: new Date().toLocaleString() });
            showMessageBox(`Ride confirmed to ${destination} with ${driverName}. Driver has been notified via WhatsApp.`, 4000);
            
            // Optionally open WhatsApp
            const whatsappUrl = `https://wa.me/${driverPhone.replace(/[^0-9]/g, '')}?text=New%20booking%20to%20${encodeURIComponent(destination)}%20for%20$${cost}.%20Please%20confirm.`;
            window.open(whatsappUrl, '_blank');

            displayRideHistory();
        }

        // Display ride history
        function displayRideHistory() {
            historyContainer.innerHTML = '';
            if (rideHistory.length === 0) {
                historyContainer.innerHTML = '<p>No ride history yet.</p>';
            } else {
                rideHistory.forEach(ride => {
                    historyContainer.innerHTML += `
                        <div class="card p-4 mb-4">
                            <p>Destination: ${ride.destination}</p>
                            <p>Cost: $${ride.cost}</p>
                            <p>Driver: ${ride.driverName}</p>
                            <p>Time: ${ride.time}</p>
                            <a href="https://wa.me/${ride.driverPhone.replace(/[^0-9]/g, '')}?text=Regarding%20your%20ride%20to%20${encodeURIComponent(ride.destination)}." target="_blank" class="btn-primary mt-2 inline-block rounded-md">Message Driver</a>
                        </div>
                    `;
                });
            }
            document.getElementById('ride-history').classList.remove('hidden');
        }

        // Initialize the map
        function initMap(centerCoords, markersData) {
            // Check if map already initialized
            let mapElement = document.getElementById('map');
            if (mapElement._leaflet_id) { // If Leaflet has initialized it
                mapElement._leaflet_id = null; // Clear old map to reinitialize
                mapElement.innerHTML = '';
            }

            const map = L.map('map').setView(centerCoords, 14);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: 'Â© OpenStreetMap'
            }).addTo(map);

            // Add all predefined locations to the map
            Object.entries(localTransportData).forEach(([location, data]) => {
                L.marker(data.coords).addTo(map).bindPopup(location);
            });

            // Add driver markers
            markersData.forEach(driver => {
                L.marker(driver.coords).addTo(map).bindPopup(`Driver: ${driver.name} (Car: ${driver.carReg})`);
            });

            // Live user's location (only for passenger view, admin doesn't need personal location on map)
            if (!isAdmin && navigator.geolocation) { // Only attempt to get user location if not admin
                navigator.geolocation.watchPosition(position => {
                    const userCoords = [position.coords.latitude, position.coords.longitude];

                    // Update user's marker or create it if it doesn't exist
                    if (userMarker) {
                        userMarker.setLatLng(userCoords);
                    } else {
                        userMarker = L.marker(userCoords).addTo(map).bindPopup("Your Location").openPopup();
                    }

                    // map.setView(userCoords, 14); // Keep map centered on user
                }, (error) => { // Removed showMessageBox
                    console.warn('Geolocation error:', error.message);
                });
            } else if (isAdmin && userMarker) { // If admin logs in and userMarker exists from prior passenger session, remove it
                userMarker.remove();
                userMarker = null;
            }

            document.getElementById('map').classList.remove('hidden');
        }

        // Handle driver registration
        async function registerDriver() {
            const driverName = document.getElementById('driverName').value;
            const driverPhone = document.getElementById('driverPhone').value;
            const driverCarReg = document.getElementById('driverCarReg').value;
            // Removed driverCapacity, driverLatitude, driverLongitude inputs from HTML

            if (!driverName || !driverPhone || !driverCarReg) {
                showMessageBox('Please fill in all driver details (Name, Phone Number, Car Registration).', 3000);
                return;
            }

            const newDriver = {
                _id: generateUUID(), // MongoDB uses _id, let's generate client-side
                name: driverName,
                phone: driverPhone,
                carReg: driverCarReg,
                capacity: 4, // Default capacity since it's not provided by admin
                coords: [-17.9319, 25.8306], // Default coordinates for Victoria Falls Town Center
                available: true // Default status
            };

            await insertDriver(newDriver); // Insert into MongoDB via LLM
            
            // Clear form fields after submission
            document.getElementById('driverName').value = '';
            document.getElementById('driverPhone').value = '';
            document.getElementById('driverCarReg').value = '';
        }

        // Display drivers in admin dashboard
        function displayAdminDrivers() {
            driverListContainer.innerHTML = '';
            if (drivers.length === 0) {
                driverListContainer.innerHTML = '<p>No drivers registered yet.</p>';
                return;
            }
            drivers.forEach(driver => {
                driverListContainer.innerHTML += `
                    <div class="card p-4 mb-2 flex justify-between items-center">
                        <div>
                            <h4 class="font-semibold">${driver.name} (Car: ${driver.carReg})</h4>
                            <p>Phone: ${driver.phone} | Status: ${driver.available ? 'Available' : 'Not Available'}</p>
                            <!-- Removed display of Coords and Capacity for simplicity -->
                        </div>
                        <button class="btn-primary bg-red-600 hover:bg-red-700 rounded-md" onclick="deleteDriver('${driver._id}', '${driver.name}')">Delete</button>
                    </div>
                `;
            });
        }

        // Handle back to login buttons
        function setupBackButtons() {
            document.getElementById('backToLogin').addEventListener('click', function() {
                mainApp.classList.add('hidden');
                authSection.classList.remove('hidden');
                document.getElementById('passenger-login').classList.remove('hidden');
                document.getElementById('admin-login').classList.add('hidden');
                document.querySelector('.login-tab[data-tab="passenger"]').classList.add('active');
                document.querySelector('.login-tab[data-tab="admin"]').classList.remove('active');
            });

            document.getElementById('backToLoginAdmin').addEventListener('click', function() {
                adminDashboard.classList.add('hidden'); // Hide admin dashboard
                authSection.classList.remove('hidden'); // Show auth section
                document.getElementById('passenger-login').classList.add('hidden'); // Ensure admin login is visible
                document.getElementById('admin-login').classList.remove('hidden');
                document.querySelector('.login-tab[data-tab="passenger"]').classList.remove('active');
                document.querySelector('.login-tab[data-tab="admin"]').classList.add('active');
            });

            document.getElementById('backToLoginAdmin2').addEventListener('click', function() {
                adminDashboard.classList.add('hidden'); // Hide admin dashboard
                authSection.classList.remove('hidden'); // Show auth section
                document.getElementById('passenger-login').classList.add('hidden'); // Ensure admin login is visible
                document.getElementById('admin-login').classList.remove('hidden');
                document.querySelector('.login-tab[data-tab="passenger"]').classList.remove('active');
                document.querySelector('.login-tab[data-tab="admin"]').classList.add('active');
            });
        }

        // Handle login tab switching (Admin/Passenger)
        function setupLoginTabs() {
            const tabs = document.querySelectorAll('#auth-section .login-tab');
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    document.getElementById('passenger-login').classList.toggle('hidden', this.dataset.tab !== 'passenger');
                    document.getElementById('admin-login').classList.toggle('hidden', this.dataset.tab !== 'admin');
                });
            });

            // Admin Dashboard tab switching (Register Driver/Manage Drivers)
            const adminTabs = document.querySelectorAll('#admin-dashboard .login-tab');
            adminTabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    adminTabs.forEach(t => t.classList.remove('active'));
                    this.classList.add('active');

                    document.getElementById('driver-registration').classList.toggle('hidden', this.dataset.tab !== 'register-driver');
                    document.getElementById('manage-drivers').classList.toggle('hidden', this.dataset.tab !== 'manage-drivers');
                    
                    if (this.dataset.tab === 'manage-drivers') {
                        fetchDrivers(); // Refresh drivers when manage tab is opened
                    }
                });
            });
        }

        // Admin login functionality
        document.getElementById('adminLoginBtn').addEventListener('click', function() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;

            // Using hardcoded credentials for demo. In production, connect to a real auth system.
            if (username === 'Munkuli$1996' && password === 'PickGod') {
                showMessageBox('Admin logged in successfully!', 2000);
                isAdmin = true;
                authSection.classList.add('hidden');
                adminDashboard.classList.remove('hidden'); // Show admin dashboard
                // Default to register driver tab
                document.querySelector('#admin-dashboard .login-tab[data-tab="register-driver"]').click(); 
                // When admin logs in, remove any existing user marker on the map
                if (userMarker) {
                    userMarker.remove();
                    userMarker = null;
                }
            } else {
                showMessageBox('Invalid admin credentials!', 3000);
            }
        });

        // Passenger login functionality
        document.getElementById('passengerLoginBtn').addEventListener('click', async function() {
            const username = document.getElementById('passengerUsername').value;
            const password = document.getElementById('passengerPassword').value;

            // Using simple client-side check for demo. In production, use real auth.
            if (username && password) {
                showMessageBox('Passenger logged in successfully!', 2000);
                isAdmin = false;
                authSection.classList.add('hidden');
                mainApp.classList.remove('hidden');
                populateLocations();
                await fetchDrivers(); // Fetch drivers for trip planning
                // The map's geolocation watchPosition will handle the user's location automatically
            } else {
                showMessageBox('Please enter both username and password.', 3000);
            }
        });

        // Event listeners
        document.getElementById('registerDriverBtn').addEventListener('click', registerDriver);
        planTripBtn.addEventListener('click', planTrip);
        document.getElementById('refreshDriversBtn').addEventListener('click', fetchDrivers); // Refresh button for admin

        // Initial Setup
        setupLoginTabs();
        setupBackButtons();

        // Initial fetch of drivers when the page loads (for passenger view or immediate admin access)
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchDrivers(); // Fetch initial list of drivers
            // If admin logs in first, it will trigger another fetch.
            // If passenger logs in first, this initial fetch ensures drivers are available.
        });

        // Initial map setup (centered on Vic Falls Town Center) - adjust if needed
        initMap(localTransportData["Town Center"].coords, []); // Initialize map with no drivers initially, they'll be fetched.
    </script>
</body>
</html>
